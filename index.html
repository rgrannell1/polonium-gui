<!DOCTYPE html>
<html lang="en">
<html>
	<head>
	<title>Polonium</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link href="css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

	<script type="text/javascript" src="js/jquery.js"></script>

	<link href="css/polo.css" rel="stylesheet" type="text/css">


	<script type="text/javascript">

		/*
			Require dependencies.
		*/

		const is       = require('is')
		const polonium = require('./polonium/polonium').main
		const cprocess = require('child_process')

	</script>

	</head>
	<body>

	<div class="container">
		<form class="form-main" role="form">

			<!-- The salt input field. -->

			<div class="input-group">
				<input type="text" class="form-control" spellcheck="false" value="" id="salt" placeholder="Salt" autofocus tabindex="1" maxlength="1024">
			</div>
	    	<!-- The password input field, and associated caplocks warning. -->

			<div class="input-group">
				<input type="password" class="form-control" id="password" placeholder="Master Password" tabindex="2" maxlength="1024">
			</div>
			<span id="user-prompt" class="help-block"></span>
			<!-- A large generate-password button) -->

			<button class="btn btn-lg btn-primary btn-block" type="button" id="get-password" tabindex="3">Get Password</button>

		</form>
    </div>
	</body>

	<script type="text/javascript">

		/*
			toClipboard :: string -> function -> undefined

			Copy a string to the clipboard. In this case, copy the new password
			after it is created.

			linux:
				xclip.
		*/

		const toClipboard = function (str, callback) {

			if (!is.string(str)) {
				throw 'toClipboard: str must be a string; actual class was ' + is.what(str)
			}
			if (!is.function(callback)) {
				throw 'toClipboard: callback must be a function; actual class was ' + is.what(callback)
			}

			// NOTE:
			// passing callback to cprocess.exec doesn't execute the callback,
			// and if xclip is installed the command should always work.
			// copying is fast, so just run the callback as a standalone block, not
			// as an argument to exec. (for the moment)
			cprocess.exec('echo "' + str + '" | xclip -selection clipboard')
			callback()

		}

		/*
			resetButton

		*/

		const resetButton = function () {

			$('#get-password')
			.removeClass('btn-success btn-danger')
			.addClass('btn-primary')
			.text('Get Password')

		}

		/*
			setButton

			Update the action button to let the user know the text was copied, either
			successfully or otherwise.
		*/

		const setButton = function (err, stdout, stderr) {

			if (err) {
				$('#get-password').removeClass("btn-primary").addClass("btn-danger").text("Failed!")
			} else {
				$('#get-password').removeClass("btn-primary").addClass("btn-success").text("Copied!")
			}

			setTimeout(resetButton, 2000)
		}

		/*
			validate


		*/

		const validate = function (salt, password) {

			if (salt.length === 0) {
				return {
					message: "You can't leave this empty.",
					input  : "#salt"
				}
			}

			if (password.length === 0) {
				return {
					message: "You can't leave this empty.",
					input  : "#password"
				}
			}

		}

		// when not focused on a field, if input invalid
		// highlight red and insert a line of red text below.

		/*
			button on click event.
		*/

		$("#get-password").click(function () {

			$('#salt', '#password').parent(".input-group").removeClass("has-error")
			$("#user-prompt").text('')

			const err = validate(
				$('#salt'    ).val(),
				$('#password').val()
			)

			if (err) {

				$(err.input).parent(".input-group").addClass("has-error")
				$("#user-prompt").text(err.message)

			} else {

				toClipboard(polonium({
					salt     : $("#salt"    ).val(),
					master   : $("#password").val(),

					len      : 20,
					rounds   : 1000000
				}), setButton)

			}
		})

	</script>

</html>
